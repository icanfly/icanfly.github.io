<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.8.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="侠客行舟|技术博客|Java|分布式|架构|大数据"><title>SQL小记-改写SQL中Limit限制 | LP's Notes</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/8.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">SQL小记-改写SQL中Limit限制</h1><a id="logo" href="/.">LP's Notes</a><p class="description">侠客行舟 不进则退</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">SQL小记-改写SQL中Limit限制</h1><div class="post-meta">Jul 31, 2017<span> | </span><span class="category"><a href="/categories/原创文章/">原创文章</a></span></div><div class="clear"><div class="toc-article" id="toc"><div class="toc-title">文章目录</div><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#思路"><span class="toc-number">1.</span> <span class="toc-text">思路</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#正则表达式"><span class="toc-number">2.</span> <span class="toc-text">正则表达式</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#实现"><span class="toc-number">3.</span> <span class="toc-text">实现</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#验证"><span class="toc-number">4.</span> <span class="toc-text">验证</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2017-08-02更新"><span class="toc-number">5.</span> <span class="toc-text">2017-08-02更新</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#最新实现"><span class="toc-number">6.</span> <span class="toc-text">最新实现</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#总结"><span class="toc-number">7.</span> <span class="toc-text">总结</span></a></li></ol></div></div><div class="post-content"><p>最近在做一款大数据查询系统，该系统提供给数据分析人员一个用户交互界面，让用户提供SQL语言进行交互查询，前台应用提供一些辅助功能，这样的数据查询系统要优于通过纯console的方式进行查询，查询平台提供了用户管理，权限管理，交互易用性扩展，多引擎框架支持等。</p>
<p>最近出现的一个问题是用户提交的SQL很大部分时间上并没有携带Limit限制返回条数，导致产生了大量的数据查询浪费，因为在界面上是不会展示所有的结果数据，一般我们在前台页面上只展现少量数据，比如只展现前面100条，而这100条在很大部分情况下已经满足了分析师同学的数据分析需求，然而不太规范的SQL编写可能导致无limit关键字而导致大量的查询，所以当前的一个需求是对用户提交的SQL进行改写，将SQL中存在limit限制的地方进行判断，如果没有设置limit数或者limit大于最大限制，设置成最大限制，限制数据的查询量和返回量。</p>
<a id="more"></a>
<h1 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h1><p>因为SQL是动态变化的，想要解析出limit的话，可能需要解析整个SQL语句成SQL抽象语法树，然后遍历得到limit计算其值得到，但是对于目前这个需求，有个比较取巧的地方在于对于标准的SQL语句，Limit关键字始终位于语句最末尾的地方。形如：<code>select * from a limit 100</code>这样的SQL，可以抽象出一个正则表达式，用这个表达式去匹配用户提交的SQL，并解析出对应的limit数，并对解析的SQL进行limit替换就可以了</p>
<h1 id="正则表达式"><a href="#正则表达式" class="headerlink" title="正则表达式"></a>正则表达式</h1><p>我们要编写的其实是对SQL中limit的匹配关系解析，而SQL中limit形式其实是有两种的，一种是形如<code>select * from a limit 100</code>，另一种是形如<code>select * from a limit 0,200</code>。我在做的时候设计成了两组正则，因分析师在分析的时候大部分会使用第一种形式，如果在匹配的时候优先匹配第一种情况，这也是短路优化的一种手段吧。</p>
<p>我们的正则表达式为：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">//Limit关键字匹配: limit 10</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String LIMIT_REPR_1 = <span class="string">"^(.|\\s)+\\s+(limit|LIMIT)\\s+(\\d+)$"</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Limit关键字匹配: limit 10,100</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String LIMIT_REPR_2 = <span class="string">"^(.|\\s)+\\s+(limit|LIMIT)\\s+(\\d+)\\s*,\\s*(\\d+)$"</span>;</span><br></pre></td></tr></table></figure></p>
<p>这时有一个问题，LIMIT_REPR_2表达式出现了严重的性能问题，匹配会一直卡在这个表达式的match上，非常糟糕，慢得无法忍受。</p>
<p>需要对上面我随手写的正则表达式进行优化。 网上有一篇文章讲Java正则表达式优化的，链接在这里：<a href="http://nspace.iteye.com/blog/1929568" target="_blank" rel="noopener">Java正则表达式优化</a>，总体的思路是减少不确定的表达和累赘表达。</p>
<p>优化点：</p>
<ul>
<li>表达式(.|\s)+\s+最开始我想表达的是允许limit关键字前面可以有任意的字符和空白，它其实可以简化成.+\s+ (这里应该算是主要优化点，对于NFA的正则匹配方式优化前的表达式存在太多的折返导致性能极其低下)</li>
<li>(limit|LIMIT)这部分去掉LIMIT，可以在匹配的时候将匹配串转成小写再匹配</li>
</ul>
<p>优化后：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Limit关键字匹配: limit 10</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String LIMIT_REPR_1 = <span class="string">"^.+\\s+limit\\s+(\\d+)$"</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Limit关键字匹配: limit 10,100</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String LIMIT_REPR_2 = <span class="string">"^.+\\s+limit\\s+\\d+\\s*,\\s*(\\d+)$"</span>;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>最新更新：上述的正则表达式不能匹配带有格式（有空白符号和回车换行符的格式化语句）<br>需要进行一些修改：</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">//Limit关键字匹配: limit 10</span><br><span class="line">public static final String LIMIT_REPR_1 = &quot;^(.|\\s)+\\s+limit\\s+(\\d+)$&quot;;</span><br><span class="line"></span><br><span class="line">//Limit关键字匹配: limit 10,100</span><br><span class="line">public static final String LIMIT_REPR_2 = &quot;^(.|\\s)+\\s+limit\\s+\\d+\\s*,\\s*(\\d+)$&quot;;</span><br></pre></td></tr></table></figure>
<p>这组的正则表达式性能是极低的，复杂的sql基本上匹配会卡住非常非常长的时间</p>
<p>继续优化：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">//Limit关键字匹配: limit 10</span><br><span class="line">public static final String LIMIT_REPR_1 = &quot;^(.|[ \\f\\n\\r\\t\\v])+\\s+limit\\s+(\\d+)$&quot;;</span><br><span class="line"></span><br><span class="line">//Limit关键字匹配: limit 10,100</span><br><span class="line">public static final String LIMIT_REPR_2 = &quot;^(.|[ \\f\\n\\r\\t\\v])+\\s+limit\\s+\\d+\\s*,\\s*(\\d+)$&quot;;</span><br></pre></td></tr></table></figure></p>
<p>实战中我也发现，正如上文中正则表达式优化所说的：<code>\s匹配任何空白字符，包括空格、制表符、换页符等等。等价于 [ \f\n\r\t\v]。</code>，但是如果我们用\s来替换[ \f\n\r\t\v]，得到的表达式性能极差，但是如果我们换用确定性的[ \f\n\r\t\v]来替换，则性能则变得很好了，这也许就是Java正则表达式引擎做的优化手段吧？</p>
<h1 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h1><p>以下代码仅作参考，实则在某些sql条件下会有性能问题<br>如果有更好的正则表达式的写法，欢迎联系我</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * SQL查询Limit改写器</span></span><br><span class="line"><span class="comment"> * Created by luopeng on 2017/8/1.</span></span><br><span class="line"><span class="comment"> * 因正则写得不太好，匹配时可能会出现性能问题，导致CPU 100%</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Deprecated</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">QuerySqlLimiter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//Limit关键字匹配: limit 10</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String LIMIT_REPR_1 = <span class="string">"^(.|[ \\f\\n\\r\\t\\v])+[ \f\n\r\t\v]+limit[ \f\n\r\t\v]+(\\d+)$"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//Limit关键字匹配: limit 10,100</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String LIMIT_REPR_2 = <span class="string">"^(.|[ \\f\\n\\r\\t\\v])+[ \f\n\r\t\v]+limit[ \f\n\r\t\v]+\\d+[ \f\n\r\t\v]*,[ \f\n\r\t\v]*(\\d+)$"</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> Pattern p1 = Pattern.compile(LIMIT_REPR_1);</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> Pattern p2 = Pattern.compile(LIMIT_REPR_2);</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">rewriteForPrestoSql</span><span class="params">(String querySql, <span class="keyword">int</span> queryLimit)</span> </span>&#123;</span><br><span class="line">		String result = matchPatter_1(querySql, queryLimit);</span><br><span class="line">		<span class="keyword">if</span> (result != <span class="keyword">null</span>)</span><br><span class="line">			<span class="keyword">return</span> result;</span><br><span class="line">		<span class="keyword">return</span> querySql + <span class="string">" limit "</span> + queryLimit;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">rewriteForHiveSql</span><span class="params">(String querySql, <span class="keyword">int</span> queryLimit)</span> </span>&#123;</span><br><span class="line">		String result = matchPatter_1(querySql, queryLimit);</span><br><span class="line">		<span class="keyword">if</span> (result != <span class="keyword">null</span>)</span><br><span class="line">			<span class="keyword">return</span> result;</span><br><span class="line"></span><br><span class="line">		<span class="comment">//匹配第二种情况</span></span><br><span class="line">		result = matchPatter_2(querySql, queryLimit);</span><br><span class="line">		<span class="keyword">if</span> (result != <span class="keyword">null</span>)</span><br><span class="line">			<span class="keyword">return</span> result;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> querySql + <span class="string">" limit "</span> + queryLimit;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">static</span> String <span class="title">matchPatter_1</span><span class="params">(String querySql, <span class="keyword">int</span> queryLimit)</span> </span>&#123;</span><br><span class="line">		String result = resolveMatcher(querySql, queryLimit, p1.matcher(querySql.toLowerCase()), <span class="number">2</span>);</span><br><span class="line">		<span class="keyword">if</span> (result != <span class="keyword">null</span>)</span><br><span class="line">			<span class="keyword">return</span> result;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">static</span> String <span class="title">matchPatter_2</span><span class="params">(String querySql, <span class="keyword">int</span> queryLimit)</span> </span>&#123;</span><br><span class="line">		String result = resolveMatcher(querySql, queryLimit, p2.matcher(querySql.toLowerCase()), <span class="number">2</span>);</span><br><span class="line">		<span class="keyword">if</span> (result != <span class="keyword">null</span>)</span><br><span class="line">			<span class="keyword">return</span> result;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">static</span> String <span class="title">resolveMatcher</span><span class="params">(String querySql, <span class="keyword">int</span> queryLimit, Matcher m, <span class="keyword">int</span> group)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (m.matches()) &#123;</span><br><span class="line">			<span class="keyword">int</span> idx = m.start(group);</span><br><span class="line">			<span class="keyword">int</span> limit = Integer.parseInt(m.group(group));</span><br><span class="line">			<span class="keyword">if</span> (limit &gt; queryLimit) &#123;</span><br><span class="line">				<span class="keyword">return</span> querySql.substring(<span class="number">0</span>, idx) + <span class="string">" "</span> + queryLimit;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">return</span> querySql;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * Created by luopeng on 2017/7/26.</span><br><span class="line"> */</span><br><span class="line">public class MyTest &#123;</span><br><span class="line"></span><br><span class="line">	public static void main(String[] args) &#123;</span><br><span class="line">		String sql = &quot;select * from (select a.id as userid,a.name as username from a left join b on a.id = b.userid order by a.id limit &quot;</span><br><span class="line">					 + &quot;10000) limit 300&quot;;</span><br><span class="line">		//未超出限制，返回原语句</span><br><span class="line">		System.out.println(QuerySqlLimiter.rewriteForPrestoSql(sql,500));</span><br><span class="line">		//超出限制，修改成最大限制</span><br><span class="line">		System.out.println(QuerySqlLimiter.rewriteForPrestoSql(sql,50));</span><br><span class="line"></span><br><span class="line">		sql = &quot;select * from (select a.id as userid,a.name as username from a left join b on a.id = b.userid order by a.id limit &quot;</span><br><span class="line">					 + &quot;10000) limit 0,300&quot;;</span><br><span class="line">		//未超出限制，返回原语句</span><br><span class="line">		System.out.println(QuerySqlLimiter.rewriteForPrestoSql(sql,500));</span><br><span class="line">		//超出限制，修改成最大限制</span><br><span class="line">		System.out.println(QuerySqlLimiter.rewriteForPrestoSql(sql,50));</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>输出：</p>
<blockquote>
<p>select <em> from (select a.id as userid,a.name as username from a left join b on a.id = b.userid order by a.id limit 10000) limit 300<br>select </em> from (select a.id as userid,a.name as username from a left join b on a.id = b.userid order by a.id limit 10000) limit  50<br>select <em> from (select a.id as userid,a.name as username from a left join b on a.id = b.userid order by a.id limit 10000) limit 0,300<br>select </em> from (select a.id as userid,a.name as username from a left join b on a.id = b.userid order by a.id limit 10000) limit 0, 50</p>
</blockquote>
<h1 id="2017-08-02更新"><a href="#2017-08-02更新" class="headerlink" title="2017-08-02更新"></a>2017-08-02更新</h1><ul>
<li>在上线过后的小段时间内线上服务器出现了栈溢出<code>java.lang.StackOverflowError</code>的情况。</li>
</ul>
<blockquote>
<p>注意StackOverflowError（A note about the StackOverflowError）</p>
</blockquote>
<p>  有时regex包中的Pattern类会抛出StackOverflowError。这是已知的bug #5050507的表现，它自从Java 1.4就存在于java.util.regex包中。这个bug仍然存在，因为它是“won’t fix”的状态。这个错误的出现是因为，Pattern类把一个正则表达式编译为一个用来寻找匹配的小程序。这个程序被递归调用，有时太多的递归就会导致该错误的出现。更多细节请参考bug描述。看起来大部分是在使用选择（alternation）的出现。<br>  如果你碰到了这个错误，尝试重写正则表达式，或者分为几个子表达式，然后分别单独执行。后者有时设置会提高性能。</p>
<ul>
<li><p>同时CPU开始飙高到了90%，NFA的回缩确实被验证了。以下SQL是导致SQL飙高的其中一条：</p>
<p><code>select t1.userid,t1.keyword,c.cityname,b.usermobile from( select t.userid,substring(visit_time,1,10) as visit_timeed,current_path, split_part(split_part(url_extract_query(current_url),&#39;kw=&#39;,2),&#39;&amp;&#39;,1) as keyword from hive.bdc_dwd.dw_fact_galog_pv_daily t where acct_day &gt;= &#39;2017-01-01&#39; and acct_day &lt;= &#39;2017-08-01&#39; and ((t.current_domainname=&#39;search.xxx.com&#39; and current_path like &#39;%kw=%&#39;)or(t.current_domainname=&#39;list.xxx.com&#39; and current_path like &#39;%key=%&#39;)) )t1 left join (select user_id,usermobile from hive.bdc_dwd.dw_mb_account_p group by user_id,usermobile)b on t1.userid=b.user_id left join (select user_id,cityname from hive.bdc_dwd.dw_mb_info group by user_id,cityname)c on c.user_id=t1.userid where t1.keyword in(&#39;app开发&#39;,&#39;微信开发&#39;,&#39;软件开发&#39;,&#39;UI设计&#39;,&#39;手机游戏开发&#39;,&#39;商城开发&#39;,&#39;办公系统开发&#39;,&#39;餐饮系统&#39;,&#39;教育&#39;,&#39;直播&#39;,&#39;支付系统&#39;,&#39;酒店系统开发&#39;,&#39;电商系统&#39;) group by t1.userid,t1.keyword,c.cityname,b.usermobile</code></p>
<p>出于对正则表达式的不精通，这样处理下去可能会有其它的问题出现，所以决定换一种解决思路：</p>
</li>
<li><p>对语句进行整形，去除一些分析干扰，比如将语句进行trim去掉两端空白，去掉语句最后的’;’分号等</p>
</li>
<li>检测sql中是否有limit关键字，这个可以使用Java字符串的lastIndexOf，这种确定性搜索还是相当高效的</li>
<li>当没有检索到limit关键字时，就可以直接在语句后添加Limit并加上限制数量了</li>
<li>当有检索到limit关键字后，需要判断limit后是否是形如limit xxx 或limit xxx,xxx的形式，这里需要注意的是这期间可能会有空格，回车换行符，制表符等空白字符。这个时候可以使用正则表达式，这个时候正则的匹配范围就变得很小很小了，效率很高</li>
<li><p>当上一步匹配到limit的形式后，就可以用以前的办法，对limit进行比较和替换了</p>
<h1 id="最新实现"><a href="#最新实现" class="headerlink" title="最新实现"></a>最新实现</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment"> * SQL查询Limit改写器</span></span><br><span class="line"><span class="comment"> * Created by luopeng on 2017/8/2.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">QuerySqlLimiter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> List&lt;Character&gt; SPLIT_CHARS = Arrays.asList(<span class="string">' '</span>, <span class="string">'1'</span>, <span class="string">'2'</span>, <span class="string">'3'</span>, <span class="string">'4'</span>, <span class="string">'5'</span>, <span class="string">'6'</span>, <span class="string">'7'</span>, <span class="string">'8'</span>, <span class="string">'9'</span>, <span class="string">'0'</span>,<span class="string">','</span>, <span class="string">'\n'</span>, <span class="string">'\r'</span>,</span><br><span class="line">			<span class="string">'\t'</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String LIMIT_NUM_REPR_1 = <span class="string">"^[ \\f\\n\\r\\t\\v]+(\\d+)$"</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String LIMIT_NUM_REPR_2 = <span class="string">"^[ \\f\\n\\r\\t\\v]+(\\d+)[ \\f\\n\\r\\t\\v]*,[ \\f\\n\\r\\t\\v]*(\\d+)$"</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> Pattern p3 = Pattern.compile(LIMIT_NUM_REPR_1);</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> Pattern p4 = Pattern.compile(LIMIT_NUM_REPR_2);</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> String keyword = <span class="string">"limit"</span>;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">rewriteSql</span><span class="params">(String querySql, <span class="keyword">int</span> queryLimit)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">		String originSql = querySql;</span><br><span class="line">		querySql = trimDelimiter(querySql).toLowerCase();</span><br><span class="line">		<span class="keyword">int</span> length = querySql.length();</span><br><span class="line"></span><br><span class="line">		<span class="keyword">int</span> limitIdx = StringUtils.lastIndexOf(querySql, keyword);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (limitIdx == -<span class="number">1</span>) &#123;</span><br><span class="line">			<span class="comment">//直接添加limit</span></span><br><span class="line">			<span class="keyword">return</span> originSql + <span class="string">" LIMIT "</span> + queryLimit;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">int</span> limitIdxEnd = limitIdx + keyword.length();</span><br><span class="line"></span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = limitIdxEnd; i &lt; length - <span class="number">1</span>; ++i) &#123;</span><br><span class="line">			<span class="keyword">char</span> c = querySql.charAt(i);</span><br><span class="line">			<span class="keyword">if</span> (!SPLIT_CHARS.contains(c)) &#123;</span><br><span class="line">				<span class="keyword">return</span> originSql + <span class="string">" LIMIT "</span> + queryLimit;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">//当以上的遍历完成时，证明存在LIMIT结尾，通过substring进一步分析limit数量</span></span><br><span class="line">		String limitStr = StringUtils.substring(querySql, limitIdxEnd);</span><br><span class="line">		Matcher matcher = p3.matcher(limitStr);</span><br><span class="line">		<span class="keyword">if</span> (matcher.matches()) &#123;</span><br><span class="line">			<span class="keyword">int</span> limit = Integer.parseInt(matcher.group(<span class="number">1</span>));</span><br><span class="line">			<span class="keyword">if</span> (limit &gt; queryLimit) &#123;</span><br><span class="line">				<span class="keyword">return</span> StringUtils.substring(originSql, <span class="number">0</span>,limitIdx) + <span class="string">" LIMIT "</span> + queryLimit;</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				<span class="keyword">return</span> originSql;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		matcher = p4.matcher(limitStr);</span><br><span class="line">		<span class="keyword">if</span> (matcher.matches()) &#123;</span><br><span class="line">			<span class="keyword">int</span> offset = Integer.parseInt(matcher.group(<span class="number">1</span>));</span><br><span class="line">			<span class="keyword">int</span> limit = Integer.parseInt(matcher.group(<span class="number">2</span>));</span><br><span class="line">			<span class="keyword">if</span> (limit &gt; queryLimit) &#123;</span><br><span class="line">				<span class="keyword">return</span> StringUtils.substring(originSql, <span class="number">0</span>, limitIdx) + <span class="string">" LIMIT "</span> + offset + <span class="string">","</span> + queryLimit;</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				<span class="keyword">return</span> originSql;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">//直接添加limit</span></span><br><span class="line">		<span class="keyword">return</span> originSql + <span class="string">" LIMIT "</span> + queryLimit;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">static</span> String <span class="title">trimDelimiter</span><span class="params">(String querySql)</span> </span>&#123;</span><br><span class="line">		querySql = StringUtils.trim(querySql);</span><br><span class="line">		<span class="keyword">if</span> (StringUtils.endsWith(querySql, <span class="string">";"</span>)) &#123;</span><br><span class="line">			querySql = StringUtils.substring(querySql, <span class="number">0</span>, querySql.length() - <span class="number">1</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> querySql;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>以前一直不觉得正则表达式会有什么问题，实际运用中也没有遇到和去理解正则表达式的原理。才导致出现了上面所说的问题，有时候采用比正则表达式更原始更粗暴的方式解决问题可能反而会更加高效，这也许也是自己不精通正则表达式编写的问题，后续需要多多关注。</p>
</li>
</ul>
</div><iframe src="/donate/?AliPayQR=/images/alipay.png&amp;WeChatQR=/images/wechat.png&amp;GitHub=null&amp;BTCQR=null&amp;BTCKEY=null&amp;PayPal=null" style="overflow-x:hidden; overflow-y:hidden; border:0xp none #fff; min-height:240px; width:100%;" frameborder="0" scrolling="no"></iframe><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a class="article-share-link" data-url="http://www.lpnote.com/2017/07/31/rewrite-limit-part-in-sql/" data-id="cjs2ys7l1008zazp5s1e6xv4z" data-qrcode="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMYAAADGCAAAAACs8KCBAAACHklEQVR42u3aQY6DMAwF0N7/0sx2JKbo24aRSB6rqqIhj4Vrx/584uv4dZ2/ub6uV/u25ueJCwMD47WMZBNVxnn98+frlatPwcDA2IHxLYI9sZXJs75+j4GBgRGkawmmdycGBgbGJAhO6uZq4MbAwMBIitjr+/PjuTx9fKQWx8DAeCGjGhz/8/Mj/Q0MDIxXMY7idW8w7e3hj9UwMDCWZsyP0noDE3lCWVgBAwNjA0b1QD8f/Jq0HwolKwYGxqKMZIn8QD9Zv7pmtEMMDIwNGEkad9dQRe+srPyPgYGBsRmjd8SWBOJqchmNWWBgYCzK6IXCZFvz+6Pgi4GBsTQjh03C612A/AgPAwNjJUb+46SgnYx8FYLpmY2BgbE0o/qYatE7WSd/ZRgYGGszekVmr9xNUslm0xQDA2NpRjIe0WtG9toA1UZpVItjYGBswOgNQ1SbnZMXh4GBsRujWlIm+B7mrnIaAwNjDUaehFUf0Duky8c1Cl1WDAyMhRi9gYnqiMbk6C06O8TAwFiakR+f9ZLIPJUsF6sYGBjbMCbNy7uaBL2XjoGBsSrjKF75hu5KH5NXiYGBsTZjEuZ6aVx1XGwy/IGBgbESo5caToYtHgm4GBgYGzCSrUzGKfLAWj1Vw8DAwMg/V9uW1ZUjHwYGBsagSTA5MotanhgYGBswkiJ2EmrzRsIjjUwMDIyXMyZ5V3XRamsz/xvAwMBYlPED/MHk87jO+/IAAAAASUVORK5CYII=">分享</a><div class="tags"><a href="/tags/参与开源/">参与开源</a><a href="/tags/SQL/">SQL</a></div><div class="post-nav"><a class="pre" href="/2017/08/07/troubleshooting-of-outofmemory-in-presto/">Presto内存溢出(OutOfMemory)问题排查</a><a class="next" href="/2017/07/13/ranger-based-user-data-authority-control-for-presto/">基于Apache Ranger的Presto数据权限控制</a></div><div id="container"></div><link rel="stylesheet" href="/css/default.css?v=0.0.0"><script src="/js/gitment.browser.js?v=0.0.0"></script><script>var path = "2017/07/31/rewrite-limit-part-in-sql/"
var paths = path.split("/")
var lastPathLen = paths[paths.length-1].length
var finalPath = paths[paths.length-1]
if(lastPathLen == 0) {
   finalPath = paths[paths.length-2]
}
var p = finalPath.length < 50 ? finalPath : finalPath.substring(0,49)
var gitment = new Gitment({
  id: p,
  owner: 'icanfly',
  repo: 'blog_comments',
  oauth: {
    client_id: '9d8f7a953f32b2942597',
    client_secret: 'efbc1217c60b17a9ceae6b2bbc6885dc17c51ac7',
  },
})
gitment.render('container')
</script></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"><input type="hidden" name="sitesearch" value="http://www.lpnote.com"></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/leetcode/">leetcode</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/原创文章/">原创文章</a><span class="category-list-count">38</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/原创文章/问题记录/">问题记录</a><span class="category-list-count">1</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/翻译文章/">翻译文章</a><span class="category-list-count">9</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/转载文章/">转载文章</a><span class="category-list-count">14</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/问题记录/">问题记录</a><span class="category-list-count">1</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/问题解析/" style="font-size: 15px;">问题解析</a> <a href="/tags/java/" style="font-size: 15px;">java</a> <a href="/tags/javascript/" style="font-size: 15px;">javascript</a> <a href="/tags/apache/" style="font-size: 15px;">apache</a> <a href="/tags/nginx/" style="font-size: 15px;">nginx</a> <a href="/tags/http/" style="font-size: 15px;">http</a> <a href="/tags/fastjson/" style="font-size: 15px;">fastjson</a> <a href="/tags/ranger/" style="font-size: 15px;">ranger</a> <a href="/tags/hdfs/" style="font-size: 15px;">hdfs</a> <a href="/tags/大数据/" style="font-size: 15px;">大数据</a> <a href="/tags/最佳实践/" style="font-size: 15px;">最佳实践</a> <a href="/tags/hortonworks/" style="font-size: 15px;">hortonworks</a> <a href="/tags/git/" style="font-size: 15px;">git</a> <a href="/tags/bug/" style="font-size: 15px;">bug</a> <a href="/tags/groovy/" style="font-size: 15px;">groovy</a> <a href="/tags/正则表达式/" style="font-size: 15px;">正则表达式</a> <a href="/tags/hexo/" style="font-size: 15px;">hexo</a> <a href="/tags/配置中心/" style="font-size: 15px;">配置中心</a> <a href="/tags/DIY/" style="font-size: 15px;">DIY</a> <a href="/tags/HIVE/" style="font-size: 15px;">HIVE</a> <a href="/tags/搜索引擎/" style="font-size: 15px;">搜索引擎</a> <a href="/tags/lucene/" style="font-size: 15px;">lucene</a> <a href="/tags/elasticsearch/" style="font-size: 15px;">elasticsearch</a> <a href="/tags/IDE/" style="font-size: 15px;">IDE</a> <a href="/tags/IDEA/" style="font-size: 15px;">IDEA</a> <a href="/tags/json/" style="font-size: 15px;">json</a> <a href="/tags/jackson/" style="font-size: 15px;">jackson</a> <a href="/tags/多线程/" style="font-size: 15px;">多线程</a> <a href="/tags/并发/" style="font-size: 15px;">并发</a> <a href="/tags/源码解读/" style="font-size: 15px;">源码解读</a> <a href="/tags/基础问题/" style="font-size: 15px;">基础问题</a> <a href="/tags/kafka/" style="font-size: 15px;">kafka</a> <a href="/tags/leetcode/" style="font-size: 15px;">leetcode</a> <a href="/tags/算法/" style="font-size: 15px;">算法</a> <a href="/tags/linux/" style="font-size: 15px;">linux</a> <a href="/tags/centos/" style="font-size: 15px;">centos</a> <a href="/tags/vim/" style="font-size: 15px;">vim</a> <a href="/tags/mac/" style="font-size: 15px;">mac</a> <a href="/tags/maven/" style="font-size: 15px;">maven</a> <a href="/tags/Mybatis/" style="font-size: 15px;">Mybatis</a> <a href="/tags/ORM/" style="font-size: 15px;">ORM</a> <a href="/tags/负载均衡/" style="font-size: 15px;">负载均衡</a> <a href="/tags/guava/" style="font-size: 15px;">guava</a> <a href="/tags/踩坑/" style="font-size: 15px;">踩坑</a> <a href="/tags/session/" style="font-size: 15px;">session</a> <a href="/tags/druid/" style="font-size: 15px;">druid</a> <a href="/tags/rpm/" style="font-size: 15px;">rpm</a> <a href="/tags/tomcat/" style="font-size: 15px;">tomcat</a> <a href="/tags/jetty/" style="font-size: 15px;">jetty</a> <a href="/tags/gc/" style="font-size: 15px;">gc</a> <a href="/tags/presto/" style="font-size: 15px;">presto</a> <a href="/tags/OOM/" style="font-size: 15px;">OOM</a> <a href="/tags/GC/" style="font-size: 15px;">GC</a> <a href="/tags/SVN/" style="font-size: 15px;">SVN</a> <a href="/tags/版本控制/" style="font-size: 15px;">版本控制</a> <a href="/tags/VCS/" style="font-size: 15px;">VCS</a> <a href="/tags/分支管理/" style="font-size: 15px;">分支管理</a> <a href="/tags/virtualbox/" style="font-size: 15px;">virtualbox</a> <a href="/tags/ubuntu/" style="font-size: 15px;">ubuntu</a> <a href="/tags/timewheels/" style="font-size: 15px;">timewheels</a> <a href="/tags/timer/" style="font-size: 15px;">timer</a> <a href="/tags/yarn/" style="font-size: 15px;">yarn</a> <a href="/tags/SpringCloud/" style="font-size: 15px;">SpringCloud</a> <a href="/tags/微服务/" style="font-size: 15px;">微服务</a> <a href="/tags/metrics/" style="font-size: 15px;">metrics</a> <a href="/tags/ambari/" style="font-size: 15px;">ambari</a> <a href="/tags/参与开源/" style="font-size: 15px;">参与开源</a> <a href="/tags/timewheel/" style="font-size: 15px;">timewheel</a> <a href="/tags/skywalking/" style="font-size: 15px;">skywalking</a> <a href="/tags/apm/" style="font-size: 15px;">apm</a> <a href="/tags/SQL/" style="font-size: 15px;">SQL</a> <a href="/tags/solr/" style="font-size: 15px;">solr</a> <a href="/tags/rocketmq/" style="font-size: 15px;">rocketmq</a> <a href="/tags/SpringBoot/" style="font-size: 15px;">SpringBoot</a> <a href="/tags/Spring/" style="font-size: 15px;">Spring</a> <a href="/tags/dubbo/" style="font-size: 15px;">dubbo</a> <a href="/tags/问题分析/" style="font-size: 15px;">问题分析</a> <a href="/tags/github/" style="font-size: 15px;">github</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2019/02/13/ignore_above-in-elasticsearch/">Elasticsearch中ignore_above的作用</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/02/02/java-concurrent-striped64/">java并发之Striped64解析</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/01/31/memory-leak-analysis-for-skywalking/">一次Skywalking内存泄露的原因分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/01/31/write-combining/">合并写(write combining)</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/01/31/false-sharing/">伪共享(False Sharing)</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/01/08/groovy-expr-usage/">groovy-expr-usage</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/01/08/jackson-ctrl-char-problem-resovle/">jackson-ctrl-char-problem-resovle</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/01/04/solve-a-disk-warning-illusion-caused-by-rocketmq/">solve-a-disk-warning-illusion-caused-by-rocketmq</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/12/30/hexoclient-usage/">hexoclient-usage</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/12/23/customize-instance-id-with-consul-service-registry/">定制springcloud服务注册到consul中的instanceId</a></li></ul></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2019 <a href="/." rel="nofollow">LP's Notes.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo. </a><a rel="nofollow" target="_blank" href="https://coding.net">Hosted by Coding Pages.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.2.5/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.2.5/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>