<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.8.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="侠客行舟|技术博客|Java|分布式|架构|大数据"><title>metrics系列之quickstart | LP's Notes</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/8.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">metrics系列之quickstart</h1><a id="logo" href="/.">LP's Notes</a><p class="description">侠客行舟 不进则退</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">metrics系列之quickstart</h1><div class="post-meta">Jan 15, 2017<span> | </span><span class="category"><a href="/categories/翻译文章/">翻译文章</a></span></div><div class="clear"><div class="toc-article" id="toc"><div class="toc-title">文章目录</div><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#QuickStarted"><span class="toc-number">1.</span> <span class="toc-text">QuickStarted</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Setting-Up-Maven"><span class="toc-number">1.1.</span> <span class="toc-text">Setting Up Maven</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Meters"><span class="toc-number">1.2.</span> <span class="toc-text">Meters</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Console-Reporter"><span class="toc-number">1.3.</span> <span class="toc-text">Console Reporter</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#The-Registry"><span class="toc-number">1.4.</span> <span class="toc-text">The Registry</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Gauges"><span class="toc-number">1.5.</span> <span class="toc-text">Gauges</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Counter"><span class="toc-number">1.6.</span> <span class="toc-text">Counter</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Histograms"><span class="toc-number">1.7.</span> <span class="toc-text">Histograms</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Timer"><span class="toc-number">1.8.</span> <span class="toc-text">Timer</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Health-Checks"><span class="toc-number">1.9.</span> <span class="toc-text">Health Checks</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Reporting-Via-JMX"><span class="toc-number">1.10.</span> <span class="toc-text">Reporting Via JMX</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Reporting-Via-HTTP"><span class="toc-number">1.11.</span> <span class="toc-text">Reporting Via HTTP</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Other-Reporting"><span class="toc-number">1.12.</span> <span class="toc-text">Other Reporting</span></a></li></ol></li></ol></div></div><div class="post-content"><p>dropwizard/metrics</p>
<p>Metrics是一个Java库，它能在你的生产环境中，为你的代码中提供无与伦比的洞察力。</p>
<p>Metrics提供了一个强大的工具包，用于测量生产环境中关键组件的行为。</p>
<p>它提供了常见模块支持，如：Jetty，Logback，Log4j，Apache HttpClient，Ehcache，JDBI，Jersey和报告后端（如Ganglia和Graphite）的公共库的模块，Metrics为您提供全栈可见性。</p>
<h1 id="QuickStarted"><a href="#QuickStarted" class="headerlink" title="QuickStarted"></a>QuickStarted</h1><p>下面是我们开始一个quickstart的步骤</p>
<h2 id="Setting-Up-Maven"><a href="#Setting-Up-Maven" class="headerlink" title="Setting Up Maven"></a>Setting Up Maven</h2><p>需要加入maven依赖：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.dropwizard.metrics<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>metrics-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;metrics.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>注意：你要确保metrics.version属性已经在你的pom文件中被定义，当前的版本是3.1.0</p>
</blockquote>
<p>好的，现在是时候开始为你的程序提供指标化的数据了</p>
<a id="more"></a>
<h2 id="Meters"><a href="#Meters" class="headerlink" title="Meters"></a>Meters</h2><p>一个Meter负责测量一类事件的速率（比如：请求速率/ requests per sencond）, 它提供了1分钟，5分钟，15分钟的平均值</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Meter requests = metrics.meter(<span class="string">"requests"</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleRequest</span><span class="params">(Request request, Response response)</span> </span>&#123;</span><br><span class="line">    requests.mark();</span><br><span class="line">    <span class="comment">// etc</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个meter将会测量请求速率，单位为requests per seconds</p>
<h2 id="Console-Reporter"><a href="#Console-Reporter" class="headerlink" title="Console Reporter"></a>Console Reporter</h2><p>就如听起来的一样，它会将结果汇报给标准输出，这个报告会每隔1秒钟打印一次<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ConsoleReporter reporter = ConsoleReporter.forRegistry(metrics)</span><br><span class="line">       .convertRatesTo(TimeUnit.SECONDS)</span><br><span class="line">       .convertDurationsTo(TimeUnit.MILLISECONDS)</span><br><span class="line">       .build();</span><br><span class="line">   reporter.start(<span class="number">1</span>, TimeUnit.SECONDS);</span><br></pre></td></tr></table></figure></p>
<p>so，完整的示例看起来是这个样子的：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> sample;</span><br><span class="line">  <span class="keyword">import</span> com.codahale.metrics.*;</span><br><span class="line">  <span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GetStarted</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> MetricRegistry metrics = <span class="keyword">new</span> MetricRegistry();</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String args[])</span> </span>&#123;</span><br><span class="line">      startReport();</span><br><span class="line">      Meter requests = metrics.meter(<span class="string">"requests"</span>);</span><br><span class="line">      requests.mark();</span><br><span class="line">      wait5Seconds();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">startReport</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      ConsoleReporter reporter = ConsoleReporter.forRegistry(metrics)</span><br><span class="line">          .convertRatesTo(TimeUnit.SECONDS)</span><br><span class="line">          .convertDurationsTo(TimeUnit.MILLISECONDS)</span><br><span class="line">          .build();</span><br><span class="line">      reporter.start(<span class="number">1</span>, TimeUnit.SECONDS);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">wait5Seconds</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">          Thread.sleep(<span class="number">5</span>*<span class="number">1000</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">catch</span>(InterruptedException e) &#123;&#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>pom文件的定义：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span> <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span> <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>somegroup<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>sample<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>Example project for Metrics<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">metrics.version</span>&gt;</span>3.1.0<span class="tag">&lt;/<span class="name">metrics.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.dropwizard.metrics<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>metrics-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;metrics.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>运行:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mvn package exec:java -Dexec.mainClass=sample.GetStarted</span><br></pre></td></tr></table></figure></p>
<h2 id="The-Registry"><a href="#The-Registry" class="headerlink" title="The Registry"></a>The Registry</h2><p>MetricsRegistry是整个项目的核心类，它是所有测量的容量，可以通过如下方式创建它：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> MetricRegistry metrics = <span class="keyword">new</span> MetricRegistry();</span><br></pre></td></tr></table></figure></p>
<p>你可能想把这个实例集成到你的应用生命周期中（比如使用你的依赖注入），这没有任何问题,但是建议还是静态实例化是一个最佳实践。</p>
<h2 id="Gauges"><a href="#Gauges" class="headerlink" title="Gauges"></a>Gauges</h2><p>一个gauges代表了一个瞬时度量值，例如：我们想要度量一个队列中的pending jobs数据量：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">QueueManager</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Queue queue;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">QueueManager</span><span class="params">(MetricRegistry metrics, String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.queue = <span class="keyword">new</span> Queue();</span><br><span class="line">        metrics.register(MetricRegistry.name(QueueManager.class, name, <span class="string">"size"</span>),</span><br><span class="line">                         <span class="keyword">new</span> Gauge&lt;Integer&gt;() &#123;</span><br><span class="line">                             <span class="meta">@Override</span></span><br><span class="line">                             <span class="function"><span class="keyword">public</span> Integer <span class="title">getValue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                                 <span class="keyword">return</span> queue.size();</span><br><span class="line">                             &#125;</span><br><span class="line">                         &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>当这个gauge被度量时，它将返回这个队列中的job数量</p>
<p>每个metric在注册表(registry)中都有一个唯一的名字，这个名字一般使用.号分隔，如：things.count，又或者:”com.example.Thing.latency”。MetricRegistry有一个静态的方法用于构造这些命名：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">MetricRegistry.name(QueueManager.class, <span class="string">"jobs"</span>, <span class="string">"size"</span>)</span><br></pre></td></tr></table></figure></p>
<p>以上的例子会返回: “com.example.QueueManager.jobs.size”</p>
<p>对于大多数queue或者像queue一样的数据结构，通常不希望只返回队列的大小，大多数java.util和java.util.concurrent包的size()实现都是O(n)的复杂度，这表示你的gauge将会比较慢（潜在地可能存在加锁）</p>
<h2 id="Counter"><a href="#Counter" class="headerlink" title="Counter"></a>Counter</h2><p>一个Counter实际上也是一个gauge，它是关于AtomicLong的一个泛型实例。你可以自增或者自减它的值，例如，我们可以以不同的方式来度量队列中的pending job：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Counter pendingJobs = metrics.counter(name(QueueManager.class, <span class="string">"pending-jobs"</span>));</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addJob</span><span class="params">(Job job)</span> </span>&#123;</span><br><span class="line">    pendingJobs.inc();</span><br><span class="line">    queue.offer(job);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> Job <span class="title">takeJob</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    pendingJobs.dec();</span><br><span class="line">    <span class="keyword">return</span> queue.take();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>每次该counter被计算时，它将会返回这个队列中的job数量</p>
<p>就上面看到的，counters的API是不同的，#counter(String) 取代了#register(String,Metrics)，然而你也可以使用register，然后创建一个你自己的Counter实例，但是要说一下的是，#counter(String) 帮你做了这一切，并且允许你通过该名称进行引用复用。</p>
<h2 id="Histograms"><a href="#Histograms" class="headerlink" title="Histograms"></a>Histograms</h2><p>Histogram是一个流式数据的统计分布，除了比如：最大值，最小值，平均值等，它还支持中位数，75%，90%，95%，98%，99%和99.9%的百分线<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Histogram responseSizes = metrics.histogram(name(RequestHandler.class, <span class="string">"response-sizes"</span>));</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleRequest</span><span class="params">(Request request, Response response)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// etc</span></span><br><span class="line">    responseSizes.update(response.getContent().length);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>该histogram将会度量响应的大小</p>
<h2 id="Timer"><a href="#Timer" class="headerlink" title="Timer"></a>Timer</h2><p>一个Timer提供了某个程序的耗时和调用速率<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Timer responses = metrics.timer(name(RequestHandler.class, <span class="string">"responses"</span>));</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">handleRequest</span><span class="params">(Request request, Response response)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> Timer.Context context = responses.time();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// etc;</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">"OK"</span>;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        context.stop();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>该timer会度量该段代码的调用速率以及调用的时耗。</p>
<h2 id="Health-Checks"><a href="#Health-Checks" class="headerlink" title="Health Checks"></a>Health Checks</h2><p>Metrics也提供了通过metrics-healthchecks模块集中式健康检测的能力<br>首先，创建一个健康检测注册表的实例：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> HealthCheckRegistry healthChecks = <span class="keyword">new</span> HealthCheckRegistry();</span><br></pre></td></tr></table></figure></p>
<p>其次，实现一个健康检测的子类:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DatabaseHealthCheck</span> <span class="keyword">extends</span> <span class="title">HealthCheck</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Database database;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DatabaseHealthCheck</span><span class="params">(Database database)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.database = database;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> HealthCheck.<span class="function">Result <span class="title">check</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (database.isConnected()) &#123;</span><br><span class="line">            <span class="keyword">return</span> HealthCheck.Result.healthy();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> HealthCheck.Result.unhealthy(<span class="string">"Cannot connect to "</span> + database.getUrl());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>最后注册它：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">healthChecks.register(<span class="string">"postgres"</span>, <span class="keyword">new</span> DatabaseHealthCheck(database));</span><br></pre></td></tr></table></figure></p>
<p>运行健康检测：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> Map&lt;String, HealthCheck.Result&gt; results = healthChecks.runHealthChecks();</span><br><span class="line"><span class="keyword">for</span> (Entry&lt;String, HealthCheck.Result&gt; entry : results.entrySet()) &#123;</span><br><span class="line">    <span class="keyword">if</span> (entry.getValue().isHealthy()) &#123;</span><br><span class="line">        System.out.println(entry.getKey() + <span class="string">" is healthy"</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        System.err.println(entry.getKey() + <span class="string">" is UNHEALTHY: "</span> + entry.getValue().getMessage());</span><br><span class="line">        <span class="keyword">final</span> Throwable e = entry.getValue().getError();</span><br><span class="line">        <span class="keyword">if</span> (e != <span class="keyword">null</span>) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>Metrics comes with a pre-built health check: ThreadDeadlockHealthCheck, which uses Java’s built-in thread deadlock detection to determine if any threads are deadlocked.</p>
</blockquote>
<h2 id="Reporting-Via-JMX"><a href="#Reporting-Via-JMX" class="headerlink" title="Reporting Via JMX"></a>Reporting Via JMX</h2><p>通过JMX汇报指标<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> JmxReporter reporter = JmxReporter.forRegistry(registry).build();</span><br><span class="line">reporter.start();</span><br></pre></td></tr></table></figure></p>
<p>当上面的reporter开启后，你就可以通过JConsole或者VisualVM进行MBean查看了：<br><img src="/2017/01/15/dropwizard-metrics-series-quickstart/metrics-visualvm.png"></p>
<h2 id="Reporting-Via-HTTP"><a href="#Reporting-Via-HTTP" class="headerlink" title="Reporting Via HTTP"></a>Reporting Via HTTP</h2><p>提供一个Servlet，该Servlet提供了所有metrics的json表现形式。它同样会运行健康检测，打印thread dump，提供简单的ping pong响应用于负载均衡。（当然也有分开的单独的Servlet提供单独的功能，例如：MetricsServlet, HealthCheckServlet, ThreadDumpServlet, and PingServlet）</p>
<p>如果需要使用到上面的东西，需要以下依赖：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.dropwizard.metrics<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>metrics-servlets<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;metrics.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<h2 id="Other-Reporting"><a href="#Other-Reporting" class="headerlink" title="Other Reporting"></a>Other Reporting</h2><p>除了以上的JMX和HTTP Reporter以外，还有以下一些Reporter:</p>
<ul>
<li>STDOUT, using ConsoleReporter from metrics-core</li>
<li>CSV files, using CsvReporter from metrics-core</li>
<li>SLF4J loggers, using Slf4jReporter from metrics-core</li>
<li>Ganglia, using GangliaReporter from metrics-ganglia</li>
<li>Graphite, using GraphiteReporter from metrics-graphite</li>
</ul>
</div><iframe src="/donate/?AliPayQR=/images/alipay.png&amp;WeChatQR=/images/wechat.png&amp;GitHub=null&amp;BTCQR=null&amp;BTCKEY=null&amp;PayPal=null" style="overflow-x:hidden; overflow-y:hidden; border:0xp none #fff; min-height:240px; width:100%;" frameborder="0" scrolling="no"></iframe><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a class="article-share-link" data-url="http://www.lpnote.com/2017/01/15/dropwizard-metrics-series-quickstart/" data-id="cjs2ys7ja0087azp5g558q3gn" data-qrcode="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAN4AAADeCAAAAAB3DOFrAAACuElEQVR42u3by24bMQwF0Pz/T6dAVwVay/dS0jgFzqwG8mN0FECkSeXrK76+f19/3/85sh5/9ep6ZP39xy48PDy80dRfXTlgvRyvRvIntt+Ah4eHd5uXBIP1Bt2S8kknwenlOB4eHt5Heev3559tU+Q1FQ8PD+9/4SXpdb7p78wHDw8P71O8PJ1tN+snFwsPDw/vGd5OA+xT9w/19/Dw8PDKrvpO+jsrPbStsjezxcPDw7vAy1tTediYIZMku10aPDw8vBu8nZ/36/LB+hvyo1rR3+fV3PDw8PAu8GY//tvSbXsAK1m4Iqjg4eHhHeUlW23eHts/ENA2296A8fDw8C7z2lQ436zbTX8/VBQNMDw8PLx576n4F6Y2EW+PW82q0W/AeHh4eA/y2tZXi6kT5bNdPjw8PLySt9MAm23u65JEfugqKVLg4eHh3eDNNtx2Km0wWKf1ybLi4eHhPc9LNt9ZsSA5iJBMPU/l8fDw8M7ydhpOedFhv4x77NAVHh4e3iFenubO0u72+NSxgi8eHh7eZV6b1LZFgXYp63LtOjDg4eHhPchrt/hTrbIDTTI8PDy8C7zkY8khgDYVnhV823YdHh4e3g1em7y2Ke/OwakZDA8PD+8Z3iwhzou8N0q6ERgPDw/vAi9BzgoWeSFjtsRFARoPDw/vKC8vByRJ8+w+LzrU88TDw8P7EK9NamfpbxsqosXCw8PDu8BrN+Vhzl4C8jLH8MLDw8Pb4H2X16yk2053HQzyZhseHh7eDd4sVLSHsZJFmTGOhRM8PDy8kjdraO3n8m2hYfh0PDw8vGu8WTDIk+l8ijsp+D/ej4eHh/dR3qwxNsPnT3mzHHh4eHg/htem47M2/4GQg4eHh3eN1za9ZtXitsyRH1l4OYKHh4d3gTdrgOXHp/JyxnrkWDcPDw8Pb877BaTgu2CXJkXiAAAAAElFTkSuQmCC">分享</a><div class="tags"><a href="/tags/metrics/">metrics</a></div><div class="post-nav"><a class="pre" href="/2017/01/17/sequence-message-in-kafka/">kafka顺序消息</a><a class="next" href="/2017/01/15/reliability-of-kafka-message/">kafka消息可靠性</a></div><div id="container"></div><link rel="stylesheet" href="/css/default.css?v=0.0.0"><script src="/js/gitment.browser.js?v=0.0.0"></script><script>var path = "2017/01/15/dropwizard-metrics-series-quickstart/"
var paths = path.split("/")
var lastPathLen = paths[paths.length-1].length
var finalPath = paths[paths.length-1]
if(lastPathLen == 0) {
   finalPath = paths[paths.length-2]
}
var p = finalPath.length < 50 ? finalPath : finalPath.substring(0,49)
var gitment = new Gitment({
  id: p,
  owner: 'icanfly',
  repo: 'blog_comments',
  oauth: {
    client_id: '9d8f7a953f32b2942597',
    client_secret: 'efbc1217c60b17a9ceae6b2bbc6885dc17c51ac7',
  },
})
gitment.render('container')
</script></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"><input type="hidden" name="sitesearch" value="http://www.lpnote.com"></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/leetcode/">leetcode</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/原创文章/">原创文章</a><span class="category-list-count">38</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/原创文章/问题记录/">问题记录</a><span class="category-list-count">1</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/翻译文章/">翻译文章</a><span class="category-list-count">9</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/转载文章/">转载文章</a><span class="category-list-count">14</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/问题记录/">问题记录</a><span class="category-list-count">1</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/问题解析/" style="font-size: 15px;">问题解析</a> <a href="/tags/java/" style="font-size: 15px;">java</a> <a href="/tags/javascript/" style="font-size: 15px;">javascript</a> <a href="/tags/apache/" style="font-size: 15px;">apache</a> <a href="/tags/nginx/" style="font-size: 15px;">nginx</a> <a href="/tags/http/" style="font-size: 15px;">http</a> <a href="/tags/fastjson/" style="font-size: 15px;">fastjson</a> <a href="/tags/ranger/" style="font-size: 15px;">ranger</a> <a href="/tags/hdfs/" style="font-size: 15px;">hdfs</a> <a href="/tags/大数据/" style="font-size: 15px;">大数据</a> <a href="/tags/最佳实践/" style="font-size: 15px;">最佳实践</a> <a href="/tags/hortonworks/" style="font-size: 15px;">hortonworks</a> <a href="/tags/git/" style="font-size: 15px;">git</a> <a href="/tags/bug/" style="font-size: 15px;">bug</a> <a href="/tags/groovy/" style="font-size: 15px;">groovy</a> <a href="/tags/正则表达式/" style="font-size: 15px;">正则表达式</a> <a href="/tags/hexo/" style="font-size: 15px;">hexo</a> <a href="/tags/配置中心/" style="font-size: 15px;">配置中心</a> <a href="/tags/DIY/" style="font-size: 15px;">DIY</a> <a href="/tags/HIVE/" style="font-size: 15px;">HIVE</a> <a href="/tags/搜索引擎/" style="font-size: 15px;">搜索引擎</a> <a href="/tags/lucene/" style="font-size: 15px;">lucene</a> <a href="/tags/elasticsearch/" style="font-size: 15px;">elasticsearch</a> <a href="/tags/IDE/" style="font-size: 15px;">IDE</a> <a href="/tags/IDEA/" style="font-size: 15px;">IDEA</a> <a href="/tags/json/" style="font-size: 15px;">json</a> <a href="/tags/jackson/" style="font-size: 15px;">jackson</a> <a href="/tags/多线程/" style="font-size: 15px;">多线程</a> <a href="/tags/并发/" style="font-size: 15px;">并发</a> <a href="/tags/源码解读/" style="font-size: 15px;">源码解读</a> <a href="/tags/基础问题/" style="font-size: 15px;">基础问题</a> <a href="/tags/kafka/" style="font-size: 15px;">kafka</a> <a href="/tags/leetcode/" style="font-size: 15px;">leetcode</a> <a href="/tags/算法/" style="font-size: 15px;">算法</a> <a href="/tags/linux/" style="font-size: 15px;">linux</a> <a href="/tags/centos/" style="font-size: 15px;">centos</a> <a href="/tags/vim/" style="font-size: 15px;">vim</a> <a href="/tags/mac/" style="font-size: 15px;">mac</a> <a href="/tags/maven/" style="font-size: 15px;">maven</a> <a href="/tags/Mybatis/" style="font-size: 15px;">Mybatis</a> <a href="/tags/ORM/" style="font-size: 15px;">ORM</a> <a href="/tags/负载均衡/" style="font-size: 15px;">负载均衡</a> <a href="/tags/guava/" style="font-size: 15px;">guava</a> <a href="/tags/踩坑/" style="font-size: 15px;">踩坑</a> <a href="/tags/session/" style="font-size: 15px;">session</a> <a href="/tags/druid/" style="font-size: 15px;">druid</a> <a href="/tags/rpm/" style="font-size: 15px;">rpm</a> <a href="/tags/tomcat/" style="font-size: 15px;">tomcat</a> <a href="/tags/jetty/" style="font-size: 15px;">jetty</a> <a href="/tags/gc/" style="font-size: 15px;">gc</a> <a href="/tags/presto/" style="font-size: 15px;">presto</a> <a href="/tags/OOM/" style="font-size: 15px;">OOM</a> <a href="/tags/GC/" style="font-size: 15px;">GC</a> <a href="/tags/SVN/" style="font-size: 15px;">SVN</a> <a href="/tags/版本控制/" style="font-size: 15px;">版本控制</a> <a href="/tags/VCS/" style="font-size: 15px;">VCS</a> <a href="/tags/分支管理/" style="font-size: 15px;">分支管理</a> <a href="/tags/virtualbox/" style="font-size: 15px;">virtualbox</a> <a href="/tags/ubuntu/" style="font-size: 15px;">ubuntu</a> <a href="/tags/timewheels/" style="font-size: 15px;">timewheels</a> <a href="/tags/timer/" style="font-size: 15px;">timer</a> <a href="/tags/yarn/" style="font-size: 15px;">yarn</a> <a href="/tags/SpringCloud/" style="font-size: 15px;">SpringCloud</a> <a href="/tags/微服务/" style="font-size: 15px;">微服务</a> <a href="/tags/metrics/" style="font-size: 15px;">metrics</a> <a href="/tags/ambari/" style="font-size: 15px;">ambari</a> <a href="/tags/参与开源/" style="font-size: 15px;">参与开源</a> <a href="/tags/timewheel/" style="font-size: 15px;">timewheel</a> <a href="/tags/skywalking/" style="font-size: 15px;">skywalking</a> <a href="/tags/apm/" style="font-size: 15px;">apm</a> <a href="/tags/SQL/" style="font-size: 15px;">SQL</a> <a href="/tags/solr/" style="font-size: 15px;">solr</a> <a href="/tags/rocketmq/" style="font-size: 15px;">rocketmq</a> <a href="/tags/SpringBoot/" style="font-size: 15px;">SpringBoot</a> <a href="/tags/Spring/" style="font-size: 15px;">Spring</a> <a href="/tags/dubbo/" style="font-size: 15px;">dubbo</a> <a href="/tags/问题分析/" style="font-size: 15px;">问题分析</a> <a href="/tags/github/" style="font-size: 15px;">github</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2019/02/13/ignore_above-in-elasticsearch/">Elasticsearch中ignore_above的作用</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/02/02/java-concurrent-striped64/">java并发之Striped64解析</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/01/31/memory-leak-analysis-for-skywalking/">一次Skywalking内存泄露的原因分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/01/31/write-combining/">合并写(write combining)</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/01/31/false-sharing/">伪共享(False Sharing)</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/01/08/groovy-expr-usage/">groovy-expr-usage</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/01/08/jackson-ctrl-char-problem-resovle/">jackson-ctrl-char-problem-resovle</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/01/04/solve-a-disk-warning-illusion-caused-by-rocketmq/">solve-a-disk-warning-illusion-caused-by-rocketmq</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/12/30/hexoclient-usage/">hexoclient-usage</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/12/23/customize-instance-id-with-consul-service-registry/">定制springcloud服务注册到consul中的instanceId</a></li></ul></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2019 <a href="/." rel="nofollow">LP's Notes.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo. </a><a rel="nofollow" target="_blank" href="https://coding.net">Hosted by Coding Pages.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.2.5/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.2.5/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>