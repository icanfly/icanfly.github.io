<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.8.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="侠客行舟|技术博客|Java|分布式|架构|大数据"><title>定制springcloud服务注册到consul中的instanceId | LP's Notes</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/8.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">定制springcloud服务注册到consul中的instanceId</h1><a id="logo" href="/.">LP's Notes</a><p class="description">侠客行舟 不进则退</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">定制springcloud服务注册到consul中的instanceId</h1><div class="post-meta">Dec 23, 2018<span> | </span><span class="category"><a href="/categories/原创文章/">原创文章</a></span></div><div class="clear"><div class="toc-article" id="toc"><div class="toc-title">文章目录</div><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#背景"><span class="toc-number">1.</span> <span class="toc-text">背景</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#问题"><span class="toc-number">2.</span> <span class="toc-text">问题</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#解决方案"><span class="toc-number">3.</span> <span class="toc-text">解决方案</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#一、通过注册修改微服务健康检测的url来规避"><span class="toc-number">3.1.</span> <span class="toc-text">一、通过注册修改微服务健康检测的url来规避</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#二、通过IP和端口确定instance-id的唯一性"><span class="toc-number">3.2.</span> <span class="toc-text">二、通过IP和端口确定instance-id的唯一性</span></a></li></ol></li></ol></div></div><div class="post-content"><h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>在使用SpringCloud构建微服务过程中，我们使用Consul作为服务的注册中心，中间过程也踩了不少的坑，今天又踩了一个：我们根据官方的建议，在注册springcloud服务的时候，instanceId使用的是以下的配置：<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  cloud:</span></span><br><span class="line"><span class="attr">    consul:</span></span><br><span class="line"><span class="attr">      host:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line"><span class="attr">      port:</span> <span class="number">8500</span></span><br><span class="line"><span class="attr">      discovery:</span></span><br><span class="line"><span class="attr">        health-check-path:</span> <span class="string">/management/health</span></span><br><span class="line"><span class="attr">        service-name:</span> <span class="string">mq-gateway</span></span><br><span class="line"><span class="attr">        health-check-interval:</span> <span class="number">10</span><span class="string">s</span></span><br><span class="line"><span class="attr">        prefer-ip-address:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">        instance-id:</span> <span class="string">$&#123;spring.cloud.consul.discovery.service-name&#125;:$&#123;server.port&#125;:$&#123;random.value&#125;</span></span><br></pre></td></tr></table></figure></p>
<p>重点就在于这个instance-id的配置，它由服务名+服务端口+随机值组成。这种看起来唯一且没有什么问题的配置，却是接下来坑的开始。</p>
<a id="more"></a>
<h1 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h1><p>在微服务的开发过程中，不断有开发人员抱怨在开发过程中一些不正常的停止微服务会导致consul上的服务注册实例越来越多，而且IP和端口都一模一样，究其原因是因为不正常的停止导致consul无法正常反注册服务，导致服务注册驻留在consul上，并变为critical状态，而当程序重启时，重新注册的instance-id又会随着${random.value}的配置而与之前的配置不同，这就导致了不断有不同instance-id的实例注册到consul上，而且他们的健康检测url都一样，这个时候当新服务启动后，所有的原有的critical状态的服务的健康检测都能通过，这时候看到的现象就是consul上这个服务挂了很多个实例（其实这些实例都是同一个服务实例）。</p>
<p>而且出于安全的原因，有个非常蛋疼的地方在于consul的服务实例反注册还只能由服务注册所在的机器发起才能反注册。</p>
<p>关于实例重复被注册，在SpringCloud的Github上也有讨论，<a href="https://github.com/spring-cloud/spring-cloud-consul/issues/318" target="_blank" rel="noopener">链接在这里</a>。不过从维护者的回答看出来，好像官方并没有打算做这方面的改进措施。</p>
<p>求人不如求己，自己也试着来看看有没有解决方案吧。</p>
<h1 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h1><h2 id="一、通过注册修改微服务健康检测的url来规避"><a href="#一、通过注册修改微服务健康检测的url来规避" class="headerlink" title="一、通过注册修改微服务健康检测的url来规避"></a>一、通过注册修改微服务健康检测的url来规避</h2><p>因为多个实例中健康检测的url相同，所以没法区分哪个是正常的实例，所以我们只需要将健康检测的url变成不相同即可，简单的实现如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  cloud:</span></span><br><span class="line"><span class="attr">    consul:</span></span><br><span class="line"><span class="attr">      host:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line"><span class="attr">      port:</span> <span class="number">8500</span></span><br><span class="line"><span class="attr">      discovery:</span></span><br><span class="line"><span class="attr">        health-check-path:</span> <span class="string">/$&#123;spring.cloud.consul.discovery.instance-id&#125;/management/health</span></span><br><span class="line"><span class="attr">        service-name:</span> <span class="string">mq-gateway</span></span><br><span class="line"><span class="attr">        health-check-interval:</span> <span class="number">10</span><span class="string">s</span></span><br><span class="line"><span class="attr">        prefer-ip-address:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">        instance-id:</span> <span class="string">$&#123;spring.cloud.consul.discovery.service-name&#125;:$&#123;server.port&#125;:$&#123;random.value&#125;</span></span><br></pre></td></tr></table></figure>
<p>但是这种方案有一个很大的弊端在于：健康检测的url对于每个服务来说变得不可得，都是一些随机的url，会导致外部的一些监控程序无法通过某种规则构造服务的健康检测url，从而掌握服务的健康状况，这是一种对于监控系统来说非常不友好的方式。</p>
<h2 id="二、通过IP和端口确定instance-id的唯一性"><a href="#二、通过IP和端口确定instance-id的唯一性" class="headerlink" title="二、通过IP和端口确定instance-id的唯一性"></a>二、通过IP和端口确定instance-id的唯一性</h2><p>同一个程序，多次启动导致instance-id不相同的原因在于${random.value}，我们尝试去掉它，而${spring.cloud.consul.discovery.service-name}:${server.port}并不能保证唯一性，我们需要加上一个特征使它变得唯一，很好想到的就是用IP来限制：服务名+IP+PORT，这样基本就限制住了唯一性。</p>
<p>但是有一个问题是SpringBoot或者SpringCloud并没有提供一个获取本地IP的配置项。这里我们需要仿造${random.value}的配置原理，构造一个我们自己的IP配置获取方式。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RandomValuePropertySource</span> <span class="keyword">extends</span> <span class="title">PropertySource</span>&lt;<span class="title">Random</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Name of the random &#123;<span class="doctag">@link</span> PropertySource&#125;.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String RANDOM_PROPERTY_SOURCE_NAME = <span class="string">"random"</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String PREFIX = <span class="string">"random."</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Log logger = LogFactory.getLog(RandomValuePropertySource.class);</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">RandomValuePropertySource</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>(name, <span class="keyword">new</span> Random());</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">RandomValuePropertySource</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>(RANDOM_PROPERTY_SOURCE_NAME);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> Object <span class="title">getProperty</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (!name.startsWith(PREFIX)) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</span><br><span class="line">			logger.trace(<span class="string">"Generating random property for '"</span> + name + <span class="string">"'"</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> getRandomValue(name.substring(PREFIX.length()));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">private</span> Object <span class="title">getRandomValue</span><span class="params">(String type)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (type.equals(<span class="string">"int"</span>)) &#123;</span><br><span class="line">			<span class="keyword">return</span> getSource().nextInt();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (type.equals(<span class="string">"long"</span>)) &#123;</span><br><span class="line">			<span class="keyword">return</span> getSource().nextLong();</span><br><span class="line">		&#125;</span><br><span class="line">		String range = getRange(type, <span class="string">"int"</span>);</span><br><span class="line">		<span class="keyword">if</span> (range != <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="keyword">return</span> getNextIntInRange(range);</span><br><span class="line">		&#125;</span><br><span class="line">		range = getRange(type, <span class="string">"long"</span>);</span><br><span class="line">		<span class="keyword">if</span> (range != <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="keyword">return</span> getNextLongInRange(range);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (type.equals(<span class="string">"uuid"</span>)) &#123;</span><br><span class="line">			<span class="keyword">return</span> UUID.randomUUID().toString();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> getRandomBytes();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">private</span> String <span class="title">getRange</span><span class="params">(String type, String prefix)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (type.startsWith(prefix)) &#123;</span><br><span class="line">			<span class="keyword">int</span> startIndex = prefix.length() + <span class="number">1</span>;</span><br><span class="line">			<span class="keyword">if</span> (type.length() &gt; startIndex) &#123;</span><br><span class="line">				<span class="keyword">return</span> type.substring(startIndex, type.length() - <span class="number">1</span>);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">getNextIntInRange</span><span class="params">(String range)</span> </span>&#123;</span><br><span class="line">		String[] tokens = StringUtils.commaDelimitedListToStringArray(range);</span><br><span class="line">		<span class="keyword">int</span> start = Integer.parseInt(tokens[<span class="number">0</span>]);</span><br><span class="line">		<span class="keyword">if</span> (tokens.length == <span class="number">1</span>) &#123;</span><br><span class="line">			<span class="keyword">return</span> getSource().nextInt(start);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> start + getSource().nextInt(Integer.parseInt(tokens[<span class="number">1</span>]) - start);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">long</span> <span class="title">getNextLongInRange</span><span class="params">(String range)</span> </span>&#123;</span><br><span class="line">		String[] tokens = StringUtils.commaDelimitedListToStringArray(range);</span><br><span class="line">		<span class="keyword">if</span> (tokens.length == <span class="number">1</span>) &#123;</span><br><span class="line">			<span class="keyword">return</span> Math.abs(getSource().nextLong() % Long.parseLong(tokens[<span class="number">0</span>]));</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">long</span> lowerBound = Long.parseLong(tokens[<span class="number">0</span>]);</span><br><span class="line">		<span class="keyword">long</span> upperBound = Long.parseLong(tokens[<span class="number">1</span>]) - lowerBound;</span><br><span class="line">		<span class="keyword">return</span> lowerBound + Math.abs(getSource().nextLong() % upperBound);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">private</span> Object <span class="title">getRandomBytes</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">byte</span>[] bytes = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">32</span>];</span><br><span class="line">		getSource().nextBytes(bytes);</span><br><span class="line">		<span class="keyword">return</span> DigestUtils.md5DigestAsHex(bytes);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">addToEnvironment</span><span class="params">(ConfigurableEnvironment environment)</span> </span>&#123;</span><br><span class="line">		environment.getPropertySources().addAfter(</span><br><span class="line">				StandardEnvironment.SYSTEM_ENVIRONMENT_PROPERTY_SOURCE_NAME,</span><br><span class="line">				<span class="keyword">new</span> RandomValuePropertySource(RANDOM_PROPERTY_SOURCE_NAME));</span><br><span class="line">		logger.trace(<span class="string">"RandomValuePropertySource add to Environment"</span>);</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>这个给了我们很大的提示，我们自己也可以在SpringBoot程序启动的时候注入一个我们自己的ProperySource将机器的IP作为配置项作为其它其它配置项的引用。并结合我们自己的配置中心客户端，可以在开发人员不感知的情况下就把这个事情给做掉。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">public class CustomizeApplication extends SpringApplication &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    public static ConfigurableApplicationContext run(Object source, String... args) &#123;</span><br><span class="line">        return run(new Object[] &#123; source &#125;, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static ConfigurableApplicationContext run(Object[] sources, String[] args) &#123;</span><br><span class="line"></span><br><span class="line">        advanceFetchApolloConfig(sources);</span><br><span class="line"></span><br><span class="line">        return new CustomizeApplication(sources).run(args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ...//此处省略</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    protected void configurePropertySources(ConfigurableEnvironment environment, String[] args) &#123;</span><br><span class="line">        super.configurePropertySources(environment, args);</span><br><span class="line"></span><br><span class="line">        //add local overwrite config file</span><br><span class="line">        if(localOverwriteConfig != null)&#123;</span><br><span class="line">            environment.getPropertySources().addFirst(localOverwriteConfig);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        environment.getPropertySources().addAfter(ConfigConsts.PREDECESSOR_OF_APOLLO, bootstrapConfig);</span><br><span class="line"></span><br><span class="line">        //注入Server相关属性及配置</span><br><span class="line">        environment.getPropertySources().addAfter(bootstrapConfig.getName(), new ServerPropertiesSource(environment));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ...//此处省略</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>自定义的PropertySource:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ServerPropertiesSource</span> <span class="keyword">extends</span> <span class="title">PropertySource</span>&lt;<span class="title">Object</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Logger logger = LoggerFactory.getLogger(ServerPropertiesSource.class);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String SERVER_PROPERTIES_NAME = <span class="string">"xxx.server"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String SERVER_ADDR_PATTERN = SERVER_PROPERTIES_NAME + <span class="string">".addr.pattern"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> LoadingCache&lt;String, Object&gt; loadingCache = CacheBuilder.newBuilder()</span><br><span class="line">            .expireAfterAccess(<span class="number">60</span>, TimeUnit.SECONDS)</span><br><span class="line">            .maximumSize(<span class="number">1000</span>).build(<span class="keyword">new</span> CacheLoader&lt;String, Object&gt;() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> Object <span class="title">load</span><span class="params">(String key)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                    <span class="keyword">return</span> _getProperty(key);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">    <span class="keyword">private</span> Environment environment;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ServerPropertiesSource</span><span class="params">(Environment environment)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>(SERVER_PROPERTIES_NAME, environment);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ServerPropertiesSource</span><span class="params">(String name, Environment environment)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(name, <span class="keyword">new</span> Object());</span><br><span class="line">        <span class="keyword">this</span>.environment = environment;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">getProperty</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> loadingCache.get(name);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">_getProperty</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!StringUtils.startsWithIgnoreCase(name, SERVER_PROPERTIES_NAME)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</span><br><span class="line">            logger.trace(<span class="string">"get server property for '"</span> + name + <span class="string">"'"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> getServerProperty(name.substring(SERVER_ADDR_PATTERN.length()));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Object <span class="title">getServerProperty</span><span class="params">(String subName)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.startsWithIgnoreCase(subName, <span class="string">".addr"</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> getServerIp();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Object <span class="title">getServerIp</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            String serverAddrPattern = <span class="keyword">this</span>.environment.getProperty(SERVER_ADDR_PATTERN);</span><br><span class="line">            <span class="keyword">if</span> (serverAddrPattern != <span class="keyword">null</span>) &#123;</span><br><span class="line">                Pattern pattern = Pattern.compile(serverAddrPattern);</span><br><span class="line">                <span class="keyword">return</span> InetAddressUtils.getLocalAddress(pattern);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> InetAddressUtils.getLocalAddress();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            logger.error(e.getMessage(),e);</span><br><span class="line">            <span class="keyword">throw</span> e;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">应用配置：</span><br><span class="line">```yaml</span><br><span class="line">spring:</span><br><span class="line">  cloud:</span><br><span class="line">    consul:</span><br><span class="line">      host: <span class="number">127.0</span>.0.1</span><br><span class="line">      port: <span class="number">8500</span></span><br><span class="line">      discovery:</span><br><span class="line">        health-check-path: /management/$&#123;instance-id&#125;/health</span><br><span class="line">        service-name: mq-gateway</span><br><span class="line">        health-check-interval: <span class="number">10</span>s</span><br><span class="line">        prefer-ip-address: <span class="keyword">true</span></span><br><span class="line">        instance-id: $&#123;spring.cloud.consul.discovery.service-name&#125;:$&#123;xxx.server.addr&#125;:$&#123;server.port&#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">SpringBoot启动：</span><br><span class="line"></span><br><span class="line">```java</span><br><span class="line">@SpringBootApplication</span><br><span class="line">@EnableDiscoveryClient</span><br><span class="line">@EnableApolloConfig(&#123; &quot;application&quot;, &quot;common.consul&quot;&#125;)</span><br><span class="line">public class DemoApplication &#123;</span><br><span class="line"></span><br><span class="line">	public static void main(String[] args) &#123;</span><br><span class="line">		CustomizeApplication.run(DemoApplication.class, args);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注册到Consul中的服务：<br><img src="/2018/12/23/customize-instance-id-with-consul-service-registry/consul.png"></p>
<p>至此，大功告成！</p>
</div><iframe src="/donate/?AliPayQR=/images/alipay.png&amp;WeChatQR=/images/wechat.png&amp;GitHub=null&amp;BTCQR=null&amp;BTCKEY=null&amp;PayPal=null" style="overflow-x:hidden; overflow-y:hidden; border:0xp none #fff; min-height:240px; width:100%;" frameborder="0" scrolling="no"></iframe><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a class="article-share-link" data-url="http://www.lpnote.com/2018/12/23/customize-instance-id-with-consul-service-registry/" data-id="cjs2ys7ig0084azp5m77c6k2u" data-qrcode="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAN4AAADeCAAAAAB3DOFrAAACrUlEQVR42u3a204jMRAEUP7/p3clnpCApKrbhiCdeYpgLj4TyXaq++0tPv69H4///vnzxyN/ynfX5vepDzw8PLzR0Ge3fgxI7vn52nw8j8/Bw8PDu81LJv1kQI/Pz4e1ed14eHh4r8M7u8luN814eHh4f5GXDD0faLK9xsPDw3tl3iw4yPF51toGGceyFjw8PLyY1xbAXuHzxfoeHh4e3qKqnkQG+VVJ2WxWTvv2uXh4eHgXeJuIdjaJ7xsF6vgDDw8P7zJvX5TaRBhn2w7w8PDwfpK3jyrabXH73+LpeHh4eJd5yYDaxqxZU1fy9+iJeHh4eEd5bVvVrN6UhL/5OfkrwMPDw7vBy2GzktXmdbSMJ98hHh4e3iFeu2Ftt7x73mw7/sWWGg8PD+8Qr91M54PIt9ezkKLYduPh4eFd4+Vl+wR2qhGhbRrAw8PD+xne5pd7XsTKF4m2XbX+DvHw8PDWvPwBedCwmfo398TDw8P7LV47HeeFsWRC30e3UU8ZHh4e3oi3mZpn7NmCkbyaJ324eHh4eEd5+SS+CSb2Za26OQwPDw/vMi+fvpNloN1kJ0/Mx4OHh4d3j5cP+l4TQBvR5lEIHh4e3g1esqVui/rJtbNFot6+4+Hh4V3mRWvIvpB/rTXhi6vw8PDwrvHyCGAWMbSxbx4cRwsDHh4e3lFeXmFPYtO2zN8uLcNGLjw8PLyjvLYVIJ+mN+X/fTAR1ffw8PDw1rx80p8Vq04tJ8VVeHh4eBd4m5A0DybaACI/fxYi4+Hh4e15+ZSdDGu27d6EDk+WMTw8PLxrvOJHfhk9bJoV9o0IeHh4eL/Ly6f4vOg1i3SLohoeHh7eC/BmTQZnC2B1AwEeHh7eBd6s5L8vZc22y0VjFh4eHt4F3qkC2GxpmSEPH3h4eHjp8R+gAffdgdolEQAAAABJRU5ErkJggg==">分享</a><div class="tags"><a href="/tags/SpringCloud/">SpringCloud</a><a href="/tags/微服务/">微服务</a></div><div class="post-nav"><a class="pre" href="/2018/12/30/hexoclient-usage/">hexoclient-usage</a><a class="next" href="/2018/11/23/java-dns-cache/">Java DNS缓存</a></div><div id="container"></div><link rel="stylesheet" href="/css/default.css?v=0.0.0"><script src="/js/gitment.browser.js?v=0.0.0"></script><script>var path = "2018/12/23/customize-instance-id-with-consul-service-registry/"
var paths = path.split("/")
var lastPathLen = paths[paths.length-1].length
var finalPath = paths[paths.length-1]
if(lastPathLen == 0) {
   finalPath = paths[paths.length-2]
}
var p = finalPath.length < 50 ? finalPath : finalPath.substring(0,49)
var gitment = new Gitment({
  id: p,
  owner: 'icanfly',
  repo: 'blog_comments',
  oauth: {
    client_id: '9d8f7a953f32b2942597',
    client_secret: 'efbc1217c60b17a9ceae6b2bbc6885dc17c51ac7',
  },
})
gitment.render('container')
</script></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"><input type="hidden" name="sitesearch" value="http://www.lpnote.com"></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/leetcode/">leetcode</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/原创文章/">原创文章</a><span class="category-list-count">38</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/原创文章/问题记录/">问题记录</a><span class="category-list-count">1</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/翻译文章/">翻译文章</a><span class="category-list-count">9</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/转载文章/">转载文章</a><span class="category-list-count">14</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/问题记录/">问题记录</a><span class="category-list-count">1</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/问题解析/" style="font-size: 15px;">问题解析</a> <a href="/tags/java/" style="font-size: 15px;">java</a> <a href="/tags/javascript/" style="font-size: 15px;">javascript</a> <a href="/tags/apache/" style="font-size: 15px;">apache</a> <a href="/tags/nginx/" style="font-size: 15px;">nginx</a> <a href="/tags/http/" style="font-size: 15px;">http</a> <a href="/tags/fastjson/" style="font-size: 15px;">fastjson</a> <a href="/tags/ranger/" style="font-size: 15px;">ranger</a> <a href="/tags/hdfs/" style="font-size: 15px;">hdfs</a> <a href="/tags/大数据/" style="font-size: 15px;">大数据</a> <a href="/tags/最佳实践/" style="font-size: 15px;">最佳实践</a> <a href="/tags/hortonworks/" style="font-size: 15px;">hortonworks</a> <a href="/tags/git/" style="font-size: 15px;">git</a> <a href="/tags/bug/" style="font-size: 15px;">bug</a> <a href="/tags/groovy/" style="font-size: 15px;">groovy</a> <a href="/tags/正则表达式/" style="font-size: 15px;">正则表达式</a> <a href="/tags/hexo/" style="font-size: 15px;">hexo</a> <a href="/tags/配置中心/" style="font-size: 15px;">配置中心</a> <a href="/tags/DIY/" style="font-size: 15px;">DIY</a> <a href="/tags/HIVE/" style="font-size: 15px;">HIVE</a> <a href="/tags/搜索引擎/" style="font-size: 15px;">搜索引擎</a> <a href="/tags/lucene/" style="font-size: 15px;">lucene</a> <a href="/tags/elasticsearch/" style="font-size: 15px;">elasticsearch</a> <a href="/tags/IDE/" style="font-size: 15px;">IDE</a> <a href="/tags/IDEA/" style="font-size: 15px;">IDEA</a> <a href="/tags/json/" style="font-size: 15px;">json</a> <a href="/tags/jackson/" style="font-size: 15px;">jackson</a> <a href="/tags/多线程/" style="font-size: 15px;">多线程</a> <a href="/tags/并发/" style="font-size: 15px;">并发</a> <a href="/tags/源码解读/" style="font-size: 15px;">源码解读</a> <a href="/tags/基础问题/" style="font-size: 15px;">基础问题</a> <a href="/tags/kafka/" style="font-size: 15px;">kafka</a> <a href="/tags/leetcode/" style="font-size: 15px;">leetcode</a> <a href="/tags/算法/" style="font-size: 15px;">算法</a> <a href="/tags/linux/" style="font-size: 15px;">linux</a> <a href="/tags/centos/" style="font-size: 15px;">centos</a> <a href="/tags/vim/" style="font-size: 15px;">vim</a> <a href="/tags/mac/" style="font-size: 15px;">mac</a> <a href="/tags/maven/" style="font-size: 15px;">maven</a> <a href="/tags/Mybatis/" style="font-size: 15px;">Mybatis</a> <a href="/tags/ORM/" style="font-size: 15px;">ORM</a> <a href="/tags/负载均衡/" style="font-size: 15px;">负载均衡</a> <a href="/tags/guava/" style="font-size: 15px;">guava</a> <a href="/tags/踩坑/" style="font-size: 15px;">踩坑</a> <a href="/tags/session/" style="font-size: 15px;">session</a> <a href="/tags/druid/" style="font-size: 15px;">druid</a> <a href="/tags/rpm/" style="font-size: 15px;">rpm</a> <a href="/tags/tomcat/" style="font-size: 15px;">tomcat</a> <a href="/tags/jetty/" style="font-size: 15px;">jetty</a> <a href="/tags/gc/" style="font-size: 15px;">gc</a> <a href="/tags/presto/" style="font-size: 15px;">presto</a> <a href="/tags/OOM/" style="font-size: 15px;">OOM</a> <a href="/tags/GC/" style="font-size: 15px;">GC</a> <a href="/tags/SVN/" style="font-size: 15px;">SVN</a> <a href="/tags/版本控制/" style="font-size: 15px;">版本控制</a> <a href="/tags/VCS/" style="font-size: 15px;">VCS</a> <a href="/tags/分支管理/" style="font-size: 15px;">分支管理</a> <a href="/tags/virtualbox/" style="font-size: 15px;">virtualbox</a> <a href="/tags/ubuntu/" style="font-size: 15px;">ubuntu</a> <a href="/tags/timewheels/" style="font-size: 15px;">timewheels</a> <a href="/tags/timer/" style="font-size: 15px;">timer</a> <a href="/tags/yarn/" style="font-size: 15px;">yarn</a> <a href="/tags/SpringCloud/" style="font-size: 15px;">SpringCloud</a> <a href="/tags/微服务/" style="font-size: 15px;">微服务</a> <a href="/tags/metrics/" style="font-size: 15px;">metrics</a> <a href="/tags/ambari/" style="font-size: 15px;">ambari</a> <a href="/tags/参与开源/" style="font-size: 15px;">参与开源</a> <a href="/tags/timewheel/" style="font-size: 15px;">timewheel</a> <a href="/tags/skywalking/" style="font-size: 15px;">skywalking</a> <a href="/tags/apm/" style="font-size: 15px;">apm</a> <a href="/tags/SQL/" style="font-size: 15px;">SQL</a> <a href="/tags/solr/" style="font-size: 15px;">solr</a> <a href="/tags/rocketmq/" style="font-size: 15px;">rocketmq</a> <a href="/tags/SpringBoot/" style="font-size: 15px;">SpringBoot</a> <a href="/tags/Spring/" style="font-size: 15px;">Spring</a> <a href="/tags/dubbo/" style="font-size: 15px;">dubbo</a> <a href="/tags/问题分析/" style="font-size: 15px;">问题分析</a> <a href="/tags/github/" style="font-size: 15px;">github</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2019/02/13/ignore_above-in-elasticsearch/">Elasticsearch中ignore_above的作用</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/02/02/java-concurrent-striped64/">java并发之Striped64解析</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/01/31/memory-leak-analysis-for-skywalking/">一次Skywalking内存泄露的原因分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/01/31/write-combining/">合并写(write combining)</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/01/31/false-sharing/">伪共享(False Sharing)</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/01/08/groovy-expr-usage/">groovy-expr-usage</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/01/08/jackson-ctrl-char-problem-resovle/">jackson-ctrl-char-problem-resovle</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/01/04/solve-a-disk-warning-illusion-caused-by-rocketmq/">solve-a-disk-warning-illusion-caused-by-rocketmq</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/12/30/hexoclient-usage/">hexoclient-usage</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/12/23/customize-instance-id-with-consul-service-registry/">定制springcloud服务注册到consul中的instanceId</a></li></ul></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2019 <a href="/." rel="nofollow">LP's Notes.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo. </a><a rel="nofollow" target="_blank" href="https://coding.net">Hosted by Coding Pages.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.2.5/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.2.5/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>